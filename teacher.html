<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-start justify-center min-h-screen p-6">

    <!-- Main Application Container -->
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-4xl mt-12">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Teacher Dashboard</h1>
            <p class="text-sm text-gray-500 mt-2">Live queue of students needing assistance.</p>
        </header>

        <!-- Live Queue Section -->
        <section id="teacher-view-section">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Current Queue</h2>
            <div id="teacher-view-queue" class="space-y-4">
                <!-- Queue items will be rendered here dynamically -->
                <p class="text-gray-500 text-center py-8" id="loading-message">Loading queue...</p>
            </div>
        </section>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE
        // =========================================================================
        // 1. Go to your Firebase project settings.
        // 2. Find the 'Your apps' section and click on the 'Web' app you created.
        // 3. Copy the entire 'firebaseConfig' object and paste it below,
        //    replacing the placeholder values.
        // 
        // Example:
        // const firebaseConfig = {
        //   apiKey: "AIzaSyC...",
        //   authDomain: "your-project.firebaseapp.com",
        //   ...
        // };
        // =========================================================================
       const firebaseConfig = {
  apiKey: "AIzaSyBX96xDY5ThDAZn-SckmsnfynMnQjvUc2I",
  authDomain: "helprequest-469c0.firebaseapp.com",
  projectId: "helprequest-469c0",
  storageBucket: "helprequest-469c0.firebasestorage.app",
  messagingSenderId: "1092775554304",
  appId: "1:1092775554304:web:e771c3ebac1e6ba4f597e5"
};

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = null;

        // UI Elements
        const teacherViewQueue = document.getElementById('teacher-view-queue');
        const loadingMessage = document.getElementById('loading-message');

        let app;
        let db;
        let auth;

        // Sign in anonymously to get a unique user ID
        const signIn = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                 if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                // Once authenticated, start listening for queue changes
                listenForQueueChanges();
            } catch (error) {
                console.error("Error during authentication:", error);
                // Additional instructions for the user to troubleshoot
                console.warn(
                    "If you are seeing a 'auth/configuration-not-found' error, please make sure you have enabled the 'Anonymous' provider in your Firebase Authentication settings."
                );
            }
        };

        // Listen to real-time updates from Firestore
        const listenForQueueChanges = () => {
            if (!db) {
                console.error("Database not initialized. Please configure Firebase.");
                return;
            }
            // Path to the shared public data collection
            const queueCollectionRef = collection(db, `artifacts/${appId}/public/data/help-requests`);
            
            // NOTE: We are no longer using orderBy in the Firestore query for performance.
            // The list will be sorted in the browser instead.
            const q = query(queueCollectionRef);

            // Use onSnapshot to get real-time updates
            onSnapshot(q, (snapshot) => {
                loadingMessage.classList.add('hidden');
                teacherViewQueue.innerHTML = '';
                if (snapshot.empty) {
                    teacherViewQueue.innerHTML = '<p class="text-gray-400 text-center py-8">The queue is empty. All clear!</p>';
                } else {
                    const queue = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        queue.push({ id: doc.id, ...data });
                    });
                    
                    // Client-side sorting for a faster user experience
                    queue.sort((a, b) => a.timestamp - b.timestamp);

                    queue.forEach((request) => {
                        const requestElement = document.createElement('div');
                        requestElement.className = 'flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border border-gray-200';
                        requestElement.innerHTML = `
                            <div class="flex-grow">
                                <p class="text-lg font-semibold text-gray-800">${request.firstName} ${request.lastName}</p>
                                <p class="text-sm text-gray-500">${request.requestType}</p>
                                <p class="text-xs text-gray-400 mt-1">User ID: ${request.userId}</p>
                            </div>
                            <button class="done-btn bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-5 rounded-full shadow transition-transform transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-blue-300" data-id="${request.id}">
                                Done
                            </button>
                        `;
                        teacherViewQueue.appendChild(requestElement);
                    });
                }
            }, (error) => {
                console.error("Error listening to queue changes:", error);
                loadingMessage.textContent = 'Error loading queue.';
            });
        };

        teacherViewQueue.addEventListener('click', async (event) => {
            if (event.target.classList.contains('done-btn')) {
                const requestId = event.target.dataset.id;
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/help-requests`, requestId);
                    await deleteDoc(docRef);
                    console.log(`Request ${requestId} cleared.`);
                } catch (error) {
                    console.error("Error clearing request:", error);
                }
            }
        });

        // Start the app by signing in to Firebase
        signIn();
    </script>
</body>
</html>
